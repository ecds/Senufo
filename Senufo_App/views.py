import os
import re
import collections
from urllib import urlencode
import logging
import tempfile, zipfile
from django.core.servers.basehttp import FileWrapper
import mimetypes

from django.conf import settings
from django.shortcuts import render, render_to_response
from django.http import HttpResponse, Http404
from django.db.models import Q
from django.core.paginator import Paginator, InvalidPage, EmptyPage
from django.template import RequestContext
#from django.db import connection

import csv
from django.shortcuts import render
from django.http import HttpResponse
from djqscsv import render_to_csv_response
from Senufo_App.models import Work_Records, Images, Authors, Places, Works_Places
from django.db import connection
import itertools
from django.db.models import Aggregate
from django.db.models.sql.aggregates import Aggregate as SQLAggregate
from django_mysql.models import GroupConcat

def map_working(request):
    PlaceLocations = Works_Places.objects.values('WorkPlace_id', 'Objects_Name__Author__Author_Name', 'Objects_Name__AuthorAttributionCertainty', 'Objects_Name__Author__Place_Active', 'Objects_Name__Description', 'Objects_Name__Database_Work_Name', 'Objects_Name__Work_Creation_date', 'Places_Name__Map_Place_Name', 'Places_Name__Latitude', 'Places_Name__Longitude', 'ReasonForPlace_Photograph','ReasonForPlace_Drawing','ReasonForPlace_Artist', 'ReasonForPlace_Acquisition',  'Main_Work_Image__stable_url', 'Work_URL').filter(ReasonForPlace_Artist='1')
    return render_to_csv_response(PlaceLocations, field_header_map={'WorkPlace_id': 'record_id', 'Objects_Name__Author__Author_Name': 'object_artist', 'Objects_Name__AuthorAttributionCertainty': 'artist_attribution_certainty','Objects_Name__Author__Place_Active':'artist_place_active', 'Objects_Name__Description': 'object_name', 'Objects_Name__Database_Work_Name':'object_marker_name','Objects_Name__Work_Creation_date':'object_date', 'Places_Name__Map_Place_Name':'location', 'Places_Name__Latitude':'latitude', 'Places_Name__Longitude':'longitude', 'ReasonForPlace_Photograph':'photograph','ReasonForPlace_Drawing':'drawing','ReasonForPlace_Artist':'artist', 'ReasonForPlace_Acquisition':'collection',  'Main_Work_Image__stable_url':'image', 'Work_URL':'object_webpage'})

def map_working_drawingphoto(request):
    PlaceLocationDrawingPhoto = Works_Places.objects.values('WorkPlace_id', 'Objects_Name__Author__Author_Name', 'Objects_Name__AuthorAttributionCertainty', 'Objects_Name__Author__Place_Active', 'Objects_Name__Description', 'Objects_Name__Database_Work_Name', 'Objects_Name__Work_Creation_date', 'Places_Name__Map_Place_Name', 'Places_Name__Latitude', 'Places_Name__Longitude', 'ReasonForPlace_Photograph','ReasonForPlace_Drawing','ReasonForPlace_Artist', 'ReasonForPlace_Acquisition',  'Main_Work_Image__stable_url', 'Work_URL').filter(Q(ReasonForPlace_Photograph='1') | Q(ReasonForPlace_Drawing='1'))
    return render_to_csv_response(PlaceLocationDrawingPhoto, field_header_map={'WorkPlace_id': 'record_id', 'Objects_Name__Author__Author_Name': 'object_artist', 'Objects_Name__AuthorAttributionCertainty': 'artist_attribution_certainty','Objects_Name__Author__Place_Active':'artist_place_active', 'Objects_Name__Description': 'object_name', 'Objects_Name__Database_Work_Name':'object_marker_name','Objects_Name__Work_Creation_date':'object_date', 'Places_Name__Map_Place_Name':'location', 'Places_Name__Latitude':'latitude', 'Places_Name__Longitude':'longitude', 'ReasonForPlace_Photograph':'photograph','ReasonForPlace_Drawing':'drawing','ReasonForPlace_Artist':'artist', 'ReasonForPlace_Acquisition':'collection',  'Main_Work_Image__stable_url':'image', 'Work_URL':'object_webpage'})

def map_working_collection(request):
    PlaceLocationCollection = Works_Places.objects.values('WorkPlace_id', 'Objects_Name__Author__Author_Name', 'Objects_Name__AuthorAttributionCertainty', 'Objects_Name__Author__Place_Active', 'Objects_Name__Description', 'Objects_Name__Database_Work_Name', 'Objects_Name__Work_Creation_date', 'Places_Name__Map_Place_Name', 'Places_Name__Latitude', 'Places_Name__Longitude', 'ReasonForPlace_Photograph','ReasonForPlace_Drawing','ReasonForPlace_Artist', 'ReasonForPlace_Acquisition',   'Main_Work_Image__stable_url', 'Work_URL').filter(ReasonForPlace_Acquisition='1')
    return render_to_csv_response(PlaceLocationCollection, field_header_map={'WorkPlace_id': 'record_id', 'Objects_Name__Author__Author_Name': 'object_artist', 'Objects_Name__AuthorAttributionCertainty': 'artist_attribution_certainty','Objects_Name__Author__Place_Active':'artist_place_active', 'Objects_Name__Description': 'object_name', 'Objects_Name__Database_Work_Name':'object_marker_name','Objects_Name__Work_Creation_date':'object_date', 'Places_Name__Map_Place_Name':'location', 'Places_Name__Latitude':'latitude', 'Places_Name__Longitude':'longitude', 'ReasonForPlace_Photograph':'photograph','ReasonForPlace_Drawing':'drawing','ReasonForPlace_Artist':'artist', 'ReasonForPlace_Acquisition':'collection',  'Main_Work_Image__stable_url':'image', 'Work_URL':'object_webpage'})

# Still working on this.  How to link in-lines - alternate place names, provenance fields. How to link to essay url? = All 3 are backwards ForeignKey. Check into a mySQL view (workbench) for this!!



def mapped_work_webpage_view(request):
    WorkPageInformation = Works_Places.objects.values('WorkPlace_id', 'Essay_Title', 'Main_Work_Image__Image_Name', 'Main_Work_Image__Image_Filename', 'Main_Work_Image__ImageAuthor_Name__Author_Name', 'Objects_Name__Database_Work_Name', 'Objects_Name__Description', 'Objects_Name__Work_Creation_date', 'Objects_Name__Collection_Name', 'Objects_Name__Collection_Number', 'Objects_Name__Reported_field_acquisition_name', 'Objects_Name__Reported_field_acquisition_location__Map_Place_Name', 'Objects_Name__Reported_field_acquisition_date', 'Places_Name__Map_Place_Name', 'Essay_URL', 'Objects_Name__Publication_Information', 'Essay_Author', 'Essay_Date', 'Citation_Format').annotate(Reported_Provenance_names=GroupConcat('Objects_Name__provenance__Reported_Provenance_name', distinct=True), Reported_Provenance_locations=GroupConcat('Objects_Name__provenance__Reported_Provenance_location__Map_Place_Name', distinct=True), Reported_Provenance_dates=GroupConcat('Objects_Name__provenance__Reported_Provenance_date', distinct=True), Related_Images=GroupConcat('Related_Images__Image_Name', distinct=True))
    return render_to_csv_response(WorkPageInformation, field_header_map={'WorkPlace_id':'WorkPlace_id', 'Essay_Title':'Essay_Title', 'Main_Work_Image__Image_Name':'Main_Work_Image', 'Main_Work_Image__Image_Filename':'Main_Work_Image_Filename','Main_Work_Image__ImageAuthor_Name__Author_Name':'Image_Credits', 'Objects_Name__Database_Work_Name':'Database_Work_Name', 'Objects_Name__Description':'Work_Description', 'Objects_Name__Work_Creation_date':'Work_Creation_Date', 'Objects_Name__Collection_Name':'Collection_Name', 'Objects_Name__Collection_Number':'Collection_Number', 'Objects_Name__Reported_field_acquisition_name':'Reported_field_acquisition_name', 'Objects_Name__Reported_field_acquisition_location__Map_Place_Name':'Reported_field_acquisition_location', 'Objects_Name__Reported_field_acquisition_date':'Reported_field_acquisition_date', 'Places_Name__Map_Place_Name':'Place_Name', 'Essay_URL':'Essay_URL', 'Objects_Name__Publication_Information':'Selected_Publication_History', 'Essay_Author':'Essay_Author', 'Essay_Date':'Essay_Date', 'Citation_Format': 'Citation_Format'})
    

def exportworks_latlong(request):
    WorksLoc = Work_Records.objects.values('Object_id', 'Database_Work_Name', 'Map_Work_Name', 'Work_Type', 'Description', 'Author__Author_Name', 'AuthorAttributionCertainty', 'Author_Attribution_Certainty_Numeric', 'Label', 'Material', 'Dimensions', 'Publication_Information', 'Work_Creation_date', 'Start_date', 'End_date', 'By_date', 'Not_after_date', 'Card_creator', 'Card_creator_date', 'Card_editor_1', 'Card_edited_date_1', 'Card_editor_2', 'Card_edited_date_2', 'Card_editor_3', 'Card_edited_date_3', 'Additional_card_editors_and_dates', 'Collection_Name', 'Collection_Number', 'Collection_Information', 'Other_Publications', 'Not_For_Map', 'Reported_field_acquisition_name', 'Reported_field_acquisition_method',  'Reported_field_acquisition_location__Map_Place_Name', 'Reported_field_acquisition_location__Latitude', 'Reported_field_acquisition_location__Longitude', 'Reported_field_acquisition_date', 'Reported_field_acquisition_date_numeric', 'Reported_field_acquisition_cost', 'Reported_field_acquisition_cost_numeric', 'Reported_estimated_insurance', 'Reported_estimated_insurance_date', 'Reported_acquired_from',  'Reported_field_acquisition_certainty_notes', 'Reported_field_acquisition_certainty_numeric', 'Reported_field_acquisition_provenance_order', 'Reported_origin_name', 'Reported_origin_location__Map_Place_Name', 'Reported_origin_location__Latitude', 'Reported_origin_location__Longitude', 'Reported_origin_date', 'Reported_origin_date_numeric', 'Reported_origin_certainty_notes', 'Reported_origin_certainty_numeric', 'ResearchNotes1', 'ResearchNotes2', 'Reported_field_acquisition_notes', 'Reported_origin_notes','provenance__Reported_Provenance_name','provenance__Reported_Provenance_date', 'provenance__Reported_Provenance_start_date_numeric','provenance__Reported_Provenance_end_date','provenance__Known_previous_provenance__Reported_Provenance_name')
    return render_to_csv_response(WorksLoc, field_header_map={'Reported_field_acquisition_location__Map_Place_Name':'Reported_field_acquisition_location', 'Reported_field_acquisition_location__Latitude':'Field_Acquisition_Latitude', 'Reported_field_acquisition_location__Longitude':'Field_Acquisition_Longitude','Reported_origin_location__Map_Place_Name':'Reported_origin_Place_Name','Reported_origin_location__Latitude':'Origin_Latitude','Reported_origin_location__Longitude':'Origin_Longitude', 'Author__Author_Name':'Creator', 'AuthorAttributionCertainty':'CreatorAttributionCertainty', 'Author_Attribution_Certainty_Numeric':'Creator_Attribution_Certainty_Numeric'})

def exportworksplaces_latlong(request):
    WorksPlacesLoc = Works_Places.objects.values('WorkPlace_id', 'Essay_Title', 'Main_Work_Image__Image_Name', 'Objects_Name__Database_Work_Name', 'Objects_Name__Map_Work_Name', 'Places_Name__Map_Place_Name', 'Places_Name__Latitude', 'Places_Name__Longitude', 'ReasonForPlace_Artist', 'ReasonForPlace_Drawing', 'ReasonForPlace_Photograph', 'ReasonForPlace_Acquisition', 'Essay_URL', 'Essay_Author', 'Essay_Date', 'Citation_Format').annotate(Related_Images=GroupConcat('Related_Images__Image_Name', distinct=True))
    return render_to_csv_response(WorksPlacesLoc, field_header_map={'WorkPlace_id':'WorkPlace_id',  'Essay_Title':'Essay_Title', 'Main_Work_Image__Image_Name':'Main_Work_Image', 'Objects_Name__Database_Work_Name':'Database_Work_Name', 'Objects_Name__Map_Work_Name':'Map_Work_Name', 'Places_Name__Map_Place_Name':'Place_Name', 'Places_Name__Latitude':'Latitude', 'Places_Name__Longitude':'Longitude'})

def links(request):
    return  render(request, 'links.html')

def NetworkEdgesAcquiredFrom(request):
    WorksFrom = Work_Records.objects.values('Object_id', 'Database_Work_Name', 'Reported_field_acquisition_name', 'Reported_acquired_from')
    return render_to_csv_response(WorksFrom, field_header_map={'Object_id':'id', 'Reported_field_acquisition_name':'Target', 'Reported_acquired_from':'Source'})

def NetworkEdgesCreatorCollector(request):
    WorksBy = Work_Records.objects.values('Object_id', 'Database_Work_Name', 'Reported_field_acquisition_name', 'Author__Author_Name')
    return render_to_csv_response(WorksBy, field_header_map={'Object_id':'id', 'Reported_field_acquisition_name':'Target', 'Author__Author_Name':'Source'})

#    
#def mapped_work_webpage_view(request):
#    MappedWorkItems = Works_Places.objects.raw('SELECT `senufo_app_works_places`.`WorkPlace_id`, `senufo_app_work_records`.`Description`,`senufo_app_places`.`Map_Place_Name`, `senufo__db`.`senufo_app_work_records`.`Publication_Information`,`senufo__db`.`senufo_app_work_records`.`Collection_Name` AS `Collection_Name`,`senufo__db`.`senufo_app_work_records`.`Collection_Number` AS `Collection_Number`,`senufo__db`.`senufo_app_work_records`.`Reported_field_acquisition_name`,`senufo_app_places2`.`Map_Place_Name` AS `Reported_field_location`,`senufo_app_work_records`.`Reported_field_acquisition_date`,`senufo_app_images`.`Image_Filename`, GROUP_CONCAT(`senufo__db`.`senufo_app_authors`.`Author_Name`) AS `Image_Credits`, GROUP_CONCAT(`senufo_app_provenance`.`Reported_Provenance_name`) AS `Reported_Provenance_name`, GROUP_CONCAT(`senufo_app_places3`.`Map_Place_Name`) AS `Reported_Provenance_location`, GROUP_CONCAT(`senufo__db`.`senufo_app_provenance`.`Reported_Provenance_date`) AS `Reported_Provenance_date`, GROUP_CONCAT(`senufo_app_essays`.`Essay_URL`) AS `Essay_URL` FROM `senufo_app_works_places` left join `senufo_app_work_records` on `senufo_app_works_places`.`Objects_Name_id`=`senufo_app_work_records`.`Object_id`  left join `senufo_app_provenance` on `senufo_app_work_records`.`Object_id` = `senufo_app_provenance`.`Provenance_id` left join `senufo_app_images`on `senufo_app_works_places`.`Related_Image_id`=`senufo_app_images`.`id` left join `senufo_app_places`on `senufo_app_works_places`.`Places_Name_id`= `senufo_app_places`.`Places_id`  left join `senufo_app_additionalplaces` on `senufo_app_places`.`Places_id` = `senufo_app_additionalplaces`.`NGA_Place_Name_id` left join `senufo_app_essays_related_works` on `senufo_app_work_records`.`Object_id` = `senufo_app_essays_related_works`.`work_records_id` left join `senufo_app_essays` on `senufo_app_essays_related_works`.`essays_id` = `senufo_app_essays`.`id` left join `senufo_app_images_imageauthor_name` on `senufo_app_images`.`id` = `senufo_app_images_imageauthor_name`.`images_id` left join `senufo_app_authors` on `senufo_app_images_imageauthor_name`.`authors_id` = `senufo_app_authors`.`id` left join `senufo_app_places` `senufo_app_places2` on `senufo_app_work_records`.`Reported_field_acquisition_location_id` = `senufo_app_places2`.`Places_id` left join `senufo_app_places` `senufo_app_places3` on `senufo_app_provenance`.`Reported_Provenance_location_id` = `senufo_app_places3`.`Places_id` GROUP BY `senufo_app_works_places`.`WorkPlace_id`')

#    return render_to_csv_response(MappedWorkItems)

#def Page(self):
#    cursor = connection.cursor()

#    cursor.execute("CREATE VIEW `wordpress_page_view` AS SELECT `senufo_app_objects_places_reason`.`WorkPlace_id` AS `WorkPlace_id`, `senufo_app_work_records`.`Description` AS `Description`, `senufo_app_work_records`.`Work_Creation_date` AS `Date`, `senufo_app_places`.`Map_Place_Name` AS `Map_Place_Name`, `senufo_app_objects_places_reason`.`ReasonForPlace` AS `ReasonForPlace`, `senufo_app_work_records`.`Collection_Name` AS `Collection_Name`, `senufo_app_work_records`.`Collection_Number` AS `Collection_Number`, `senufo_app_images`.`Image_Filename` AS `Image_Filename`, GROUP_CONCAT(DISTINCT `senufo_app_authors`.`Author_Name` SEPARATOR ',') AS `Image_Credits`, `senufo_app_work_records`.`Reported_field_acquisition_name` AS `Reported_field_acquisition_name`, `senufo_app_places2`.`Map_Place_Name` AS `Reported_field_location`, `senufo_app_work_records`.`Reported_field_acquisition_date` AS `Reported_field_acquisition_date`, GROUP_CONCAT(DISTINCT `senufo_app_provenance`.`Reported_Provenance_name` SEPARATOR ',') AS `Reported_Provenance_name`, GROUP_CONCAT(DISTINCT `senufo_app_places3`.`Map_Place_Name` SEPARATOR ',') AS `Reported_Provenance_location`, GROUP_CONCAT(DISTINCT `senufo_app_provenance`.`Reported_Provenance_date` SEPARATOR ',') AS `Reported_Provenance_date`, `senufo_app_work_records`.`Publication_Information` AS `Selected_Publication_History`, GROUP_CONCAT(DISTINCT `senufo_app_essays`.`Essay_Title` SEPARATOR ',') AS `Essay_Title`, GROUP_CONCAT(DISTINCT `senufo_app_essays`.`Essay_Author` SEPARATOR ',') AS `Essay_Author`, GROUP_CONCAT(DISTINCT `senufo_app_essays`.`Essay_URL` SEPARATOR ',') AS `Essay_URL`, GROUP_CONCAT(DISTINCT `senufo_app_essays`.`Citation_Format` SEPARATOR ',') AS `Citation_Format`, GROUP_CONCAT(DISTINCT `senufo_app_images2`.`Image_Filename` SEPARATOR ',') AS `Related_Images`    FROM(((((((((((((`senufo_app_objects_places_reason` LEFT JOIN `senufo_app_work_records` ON ((`senufo_app_objects_places_reason`.`Objects_Name_id` = `senufo_app_work_records`.`Object_id`)) LEFT JOIN `senufo_app_provenance` ON ((`senufo_app_work_records`.`Object_id` = `senufo_app_provenance`.`Provenance_id`))) LEFT JOIN `senufo_app_images` ON ((`senufo_app_objects_places_reason`.`Related_Image_id` = `senufo_app_images`.`id`))) LEFT JOIN `senufo_app_places` ON ((`senufo_app_objects_places_reason`.`Places_Name_id` = `senufo_app_places`.`Places_id`))) LEFT JOIN `senufo_app_additionalplaces` ON ((`senufo_app_places`.`Places_id` = `senufo_app_additionalplaces`.`NGA_Place_Name_id`))) LEFT JOIN `senufo_app_essays_related_works` ON ((`senufo_app_work_records`.`Object_id` = `senufo_app_essays_related_works`.`work_records_id`))) LEFT JOIN `senufo_app_essays` ON ((`senufo_app_essays_related_works`.`essays_id` = `senufo_app_essays`.`id`))) LEFT JOIN `senufo_app_images_imageauthor_name` ON ((`senufo_app_images`.`id` = `senufo_app_images_imageauthor_name`.`images_id`))) LEFT JOIN `senufo_app_authors` ON ((`senufo_app_images_imageauthor_name`.`authors_id` = `senufo_app_authors`.`id`))) LEFT JOIN `senufo_app_places` `senufo_app_places2` ON ((`senufo_app_work_records`.`Reported_field_acquisition_location_id` = `senufo_app_places2`.`Places_id`))) LEFT JOIN `senufo_app_places` `senufo_app_places3` ON ((`senufo_app_provenance`.`Reported_Provenance_location_id` = `senufo_app_places3`.`Places_id`))) LEFT JOIN `senufo_app_essays_related_images` ON ((`senufo_app_essays`.`id` = `senufo_app_essays_related_images`.`essays_id`))) LEFT JOIN `senufo_app_images` `senufo_app_images2` ON ((`senufo_app_essays_related_images`.`images_id` = `senufo_app_images`.`id`))) GROUP BY `senufo_app_objects_places_reason`.`WorkPlace_id`")
#    row = cursor.fetchall()
        
#    render_to_response("Page.html", {"row":row})


#def Page(request):
#    Page = Objects_Places_Reason.objects.SQL()
#    render_to_response("Page.html", {"Page":Page})
